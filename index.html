<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 å•†åŸæ‹¼å•å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body{background-color:#111827}</style>
</head>
<body class="min-h-screen text-gray-100 p-4">
<div class="max-w-lg mx-auto">
    <h1 class="text-2xl font-bold text-center mb-2 text-amber-400">ğŸ›’ FF14 å•†åŸæ‹¼å•</h1>
    <p class="text-center text-gray-500 text-sm mb-6">æ•°æ®å®æ—¶åŒæ­¥</p>

    <!-- ç™»å½•é¡µé¢ -->
    <div id="authPage" class="hidden">
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4 text-center">ğŸ” ç™»å½• / æ³¨å†Œ</h2>
            <p class="text-gray-400 text-sm text-center mb-4">è¾“å…¥é‚®ç®±ï¼Œæˆ‘ä»¬ä¼šå‘é€ç™»å½•é“¾æ¥ç»™ä½ </p>
            <input type="email" id="authEmail" placeholder="ä½ çš„é‚®ç®±" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500 mb-3">
            <button id="sendMagicLinkBtn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded">å‘é€ç™»å½•é“¾æ¥</button>
            <div id="authMessage" class="mt-4 text-center text-sm hidden"></div>
        </div>
    </div>

    <!-- ç”¨æˆ·çŠ¶æ€æ  -->
    <div id="userBar" class="bg-gray-800 rounded-lg p-3 mb-4 hidden">
        <div class="flex justify-between items-center">
            <span class="text-sm text-gray-400">å·²ç™»å½•ï¼š<span id="userEmail" class="text-amber-400"></span></span>
            <button id="logoutBtn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">é€€å‡º</button>
        </div>
    </div>

    <div id="homePage" class="hidden">
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">ğŸš— åˆ›å»ºæ–°è½¦é˜Ÿ</h2>
            <button id="createBtn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded">å¼€ä¸€è¾†æ–°è½¦</button>
        </div>
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4">ğŸ« åŠ å…¥è½¦é˜Ÿ</h2>
            <input type="text" id="joinGroupId" placeholder="è½¦é˜ŸIDï¼ˆ6ä½ï¼‰" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500 mb-3 uppercase" maxlength="6">
            <button id="joinBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded">åŠ å…¥è½¦é˜Ÿ</button>
        </div>
        <div id="recentGroups" class="mt-6 hidden">
            <h3 class="text-gray-400 text-sm mb-2">æœ€è¿‘çš„è½¦é˜Ÿï¼š</h3>
            <div id="recentGroupList" class="space-y-2"></div>
        </div>
    </div>

    <div id="groupPage" class="hidden">
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <span class="text-gray-400 text-sm">è½¦é˜ŸIDï¼š</span>
                    <span id="groupIdDisplay" class="font-mono text-amber-400 text-lg"></span>
                    <button id="copyLinkBtn" class="ml-2 text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">å¤åˆ¶é“¾æ¥</button>
                </div>
                <button id="homeBtn" class="text-gray-400 hover:text-white text-sm">â† è¿”å›</button>
            </div>
        </div>

        <div id="paymentInfoSection" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3">ğŸ’° æ”¶æ¬¾ä¿¡æ¯</h2>
            <div id="paymentEditMode" class="hidden space-y-3">
                <input type="text" id="driverName" placeholder="è½¦å¤´æ˜µç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <select id="paymentMethod" class="w-full bg-gray-700 rounded px-3 py-2 text-white">
                    <option value="alipay">æ”¯ä»˜å®</option>
                    <option value="wechat">å¾®ä¿¡</option>
                    <option value="both">éƒ½å¯ä»¥</option>
                </select>
                <input type="text" id="paymentAccount" placeholder="æ”¶æ¬¾è´¦å·" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <textarea id="paymentNote" placeholder="å¤‡æ³¨" rows="2" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500"></textarea>
                <button id="savePaymentBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">ä¿å­˜æ”¶æ¬¾ä¿¡æ¯</button>
            </div>
            <div id="paymentViewMode" class="hidden bg-gray-700 rounded p-3 space-y-2">
                <p><span class="text-gray-400">è½¦å¤´ï¼š</span><span id="viewDriverName"></span></p>
                <p><span class="text-gray-400">æ”¶æ¬¾æ–¹å¼ï¼š</span><span id="viewPaymentMethod"></span></p>
                <p><span class="text-gray-400">è´¦å·ï¼š</span><span id="viewPaymentAccount" class="text-amber-400 font-mono"></span>
                    <button id="copyAccountBtn" class="ml-2 text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">å¤åˆ¶</button></p>
                <p id="viewPaymentNote" class="text-sm text-gray-400"></p>
            </div>
        </div>

        <div id="myPaymentSection" class="bg-blue-900 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3 text-blue-400">ğŸ’³ æˆ‘çš„ä»˜æ¬¾</h2>
            <div class="flex justify-between items-center mb-3">
                <span>åº”ä»˜é‡‘é¢ï¼š</span>
                <span id="myPaymentAmount" class="text-xl text-amber-400 font-bold">Â¥0</span>
            </div>
            <div id="myPaymentStatus" class="text-center py-2 rounded"></div>
        </div>

        <div id="myCodesSection" class="bg-green-900 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3 text-green-400">ğŸ æˆ‘çš„å…‘æ¢ç </h2>
            <div id="myCodesList" class="space-y-2"></div>
        </div>

        <div id="paymentManageSection" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3">ğŸ“‹ ä»˜æ¬¾ç®¡ç†</h2>
            <div id="paymentStatusList" class="space-y-2"></div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between mb-2"><span>å•†å“æ€»ä»·ï¼š</span><span id="totalPrice" class="text-white font-bold">Â¥0</span></div>
            <div class="flex justify-between mb-2"><span>å½“å‰ä¼˜æƒ ï¼š</span><span id="currentDiscount" class="text-green-400 font-bold">-Â¥0</span></div>
            <div class="border-t border-gray-700 my-2"></div>
            <div class="flex justify-between text-lg"><span>å®ä»˜é‡‘é¢ï¼š</span><span id="finalPrice" class="text-amber-400 font-bold">Â¥0</span></div>
            <div id="nextTierInfo" class="mt-3 text-sm text-gray-400 bg-gray-700 rounded p-2 hidden"></div>
            <div id="perPersonSection" class="mt-4 pt-4 border-t border-gray-700 hidden">
                <h3 class="text-sm text-gray-400 mb-2">æ¯äººåº”ä»˜ï¼š</h3>
                <div id="perPersonList" class="space-y-1"></div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-sm text-gray-400 mb-2">ä¼˜æƒ æ¢¯åº¦ï¼š</h3>
            <div id="tierBadges" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-bold mb-3">å•†å“åˆ—è¡¨ <span id="itemCount" class="text-sm text-gray-400"></span></h2>
            <div id="itemList" class="space-y-2"><p class="text-gray-500 text-center py-4">æš‚æ— å•†å“</p></div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-lg font-bold mb-3">æ·»åŠ å•†å“</h2>
            <div class="space-y-3">
                <input type="text" id="itemName" placeholder="å•†å“åç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <input type="number" id="itemPrice" placeholder="ä»·æ ¼" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <button id="addItemBtn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 rounded">â• æ·»åŠ åˆ°åˆ—è¡¨</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden z-50"></div>

<div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
        <h3 class="text-lg font-bold mb-2">å¡«å†™å…‘æ¢ç </h3>
        <p class="text-sm text-gray-400 mb-4">å•†å“ï¼š<span id="modalItemName" class="text-white"></span><br>æ‰€å±ï¼š<span id="modalItemOwner" class="text-amber-400"></span></p>
        <input type="text" id="codeInput" placeholder="ç²˜è´´å…‘æ¢ç " class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500 mb-4">
        <div class="flex gap-2">
            <button id="saveCodeBtn" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">ä¿å­˜</button>
            <button id="closeCodeBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-400 mx-auto mb-4"></div>
        <p class="text-gray-400">åŠ è½½ä¸­...</p>
    </div>
</div>

<script>
(function() {
    const SUPABASE_URL = 'https://qeoyhijdiykcmdwdrqel.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3loaWpkaXlrY21kd2RycWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODg3NTEsImV4cCI6MjA4NjI2NDc1MX0.wTeG9XQMv3ui5D1fRjqXDSJDLoWwBr0E730kIlEfN0w';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentGroupId = null;
    let currentGroup = null;
    let items = [];
    let editingItemId = null;
    let currentSubscription = null;

    const discountTiers = [
        {threshold: 50, discount: 10},
        {threshold: 200, discount: 45},
        {threshold: 400, discount: 100},
        {threshold: 1000, discount: 300}
    ];

    const $ = id => document.getElementById(id);

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        const { data: { session } } = await db.auth.getSession();
        if (session) {
            currentUser = session.user;
            showLoggedInState();
        } else {
            showAuthPage();
        }

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–ï¼ˆå¤„ç† Magic Link å›è°ƒï¼‰
        db.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                showLoggedInState();
                showToast('ç™»å½•æˆåŠŸï¼');
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                showAuthPage();
            }
        });

        // Event Listeners
        $('sendMagicLinkBtn').addEventListener('click', sendMagicLink);
        $('logoutBtn').addEventListener('click', logout);
        $('createBtn').addEventListener('click', createGroup);
        $('joinBtn').addEventListener('click', joinGroup);
        $('homeBtn').addEventListener('click', goHome);
        $('copyLinkBtn').addEventListener('click', copyGroupLink);
        $('copyAccountBtn').addEventListener('click', copyAccount);
        $('savePaymentBtn').addEventListener('click', savePaymentInfo);
        $('addItemBtn').addEventListener('click', addItem);
        $('saveCodeBtn').addEventListener('click', saveCode);
        $('closeCodeBtn').addEventListener('click', closeCodeModal);
    });

    async function sendMagicLink() {
        const email = $('authEmail').value.trim();
        if (!email) {
            showAuthMessage('è¯·è¾“å…¥é‚®ç®±', 'error');
            return;
        }

        $('sendMagicLinkBtn').disabled = true;
        $('sendMagicLinkBtn').textContent = 'å‘é€ä¸­...';

        const { error } = await db.auth.signInWithOtp({
            email: email,
            options: {
                emailRedirectTo: window.location.origin + window.location.pathname + window.location.search
            }
        });

        $('sendMagicLinkBtn').disabled = false;
        $('sendMagicLinkBtn').textContent = 'å‘é€ç™»å½•é“¾æ¥';

        if (error) {
            showAuthMessage('å‘é€å¤±è´¥ï¼š' + error.message, 'error');
        } else {
            showAuthMessage('âœ“ ç™»å½•é“¾æ¥å·²å‘é€åˆ°ä½ çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶ï¼', 'success');
        }
    }

    function showAuthMessage(msg, type) {
        const el = $('authMessage');
        el.textContent = msg;
        el.className = 'mt-4 text-center text-sm ' + (type === 'error' ? 'text-red-400' : 'text-green-400');
        el.classList.remove('hidden');
    }

    async function logout() {
        await db.auth.signOut();
        currentUser = null;
        currentGroupId = null;
        currentGroup = null;
        items = [];
        showAuthPage();
        showToast('å·²é€€å‡ºç™»å½•');
    }

    function showAuthPage() {
        $('authPage').classList.remove('hidden');
        $('userBar').classList.add('hidden');
        $('homePage').classList.add('hidden');
        $('groupPage').classList.add('hidden');
    }

    function showLoggedInState() {
        $('authPage').classList.add('hidden');
        $('userBar').classList.remove('hidden');
        $('userEmail').textContent = currentUser.email;

        // æ£€æŸ¥ URL å‚æ•°
        const params = new URLSearchParams(window.location.search);
        const groupId = params.get('g');
        if (groupId) {
            loadGroup(groupId);
        } else {
            showHomePage();
        }
        loadRecentGroups();
    }

    function showHomePage() {
        $('homePage').classList.remove('hidden');
        $('groupPage').classList.add('hidden');
        currentGroupId = null;
        currentGroup = null;
        items = [];
    }

    function goHome() {
        window.history.pushState({}, '', window.location.pathname);
        showHomePage();
    }

    function generateId() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let id = '';
        for (let i = 0; i < 6; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
        return id;
    }

    async function createGroup() {
        showLoading(true);
        const groupId = generateId();
        const {error} = await db.from('groups').insert({
            id: groupId,
            driver_id: currentUser.id
        });
        if (error) {
            showLoading(false);
            alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            return;
        }
        saveRecentGroup(groupId);
        await loadGroup(groupId);
        showToast('è½¦é˜Ÿåˆ›å»ºæˆåŠŸï¼ä½ æ˜¯è½¦å¤´');
    }

    async function joinGroup() {
        const groupId = $('joinGroupId').value.trim().toUpperCase();
        if (!groupId || groupId.length !== 6) {
            alert('è¯·è¾“å…¥6ä½è½¦é˜ŸID');
            return;
        }
        await loadGroup(groupId);
    }

    async function loadGroup(groupId) {
        showLoading(true);
        const {data: group, error} = await db.from('groups').select('*').eq('id', groupId).single();
        if (error || !group) {
            showLoading(false);
            alert('è½¦é˜Ÿä¸å­˜åœ¨');
            showHomePage();
            return;
        }
        currentGroupId = groupId;
        currentGroup = group;
        window.history.pushState({}, '', '?g=' + groupId);
        await loadItems();
        subscribeToChanges();
        saveRecentGroup(groupId);
        $('homePage').classList.add('hidden');
        $('groupPage').classList.remove('hidden');
        $('groupIdDisplay').textContent = groupId;
        updateDisplay();
        showLoading(false);
    }

    async function loadItems() {
        const {data, error} = await db.from('items').select('*').eq('group_id', currentGroupId).order('created_at', {ascending: true});
        if (!error) items = data || [];
    }

    function subscribeToChanges() {
        if (currentSubscription) {
            db.removeChannel(currentSubscription);
        }

        currentSubscription = db.channel('group-' + currentGroupId)
            .on('postgres_changes', {event: '*', schema: 'public', table: 'items', filter: 'group_id=eq.' + currentGroupId}, () => {
                loadItems().then(() => updateDisplay());
            })
            .on('postgres_changes', {event: '*', schema: 'public', table: 'groups', filter: 'id=eq.' + currentGroupId}, async () => {
                const {data} = await db.from('groups').select('*').eq('id', currentGroupId).single();
                if (data) currentGroup = data;
                updateDisplay();
            })
            .subscribe();
    }

    function saveRecentGroup(groupId) {
        let recent = JSON.parse(localStorage.getItem('ff14_recent_groups') || '[]');
        recent = recent.filter(id => id !== groupId);
        recent.unshift(groupId);
        recent = recent.slice(0, 5);
        localStorage.setItem('ff14_recent_groups', JSON.stringify(recent));
        loadRecentGroups();
    }

    function loadRecentGroups() {
        const recent = JSON.parse(localStorage.getItem('ff14_recent_groups') || '[]');
        if (recent.length > 0) {
            $('recentGroups').classList.remove('hidden');
            $('recentGroupList').innerHTML = recent.map(id => 
                '<button class="recent-group-btn w-full text-left bg-gray-800 hover:bg-gray-700 rounded p-3 text-sm" data-id="' + id + '"><span class="font-mono text-amber-400">' + id + '</span></button>'
            ).join('');
            document.querySelectorAll('.recent-group-btn').forEach(btn => {
                btn.addEventListener('click', () => loadGroup(btn.dataset.id));
            });
        } else {
            $('recentGroups').classList.add('hidden');
        }
    }

    function copyGroupLink() {
        const link = window.location.origin + window.location.pathname + '?g=' + currentGroupId;
        navigator.clipboard.writeText(link).then(() => showToast('é“¾æ¥å·²å¤åˆ¶ï¼'));
    }

    function copyAccount() {
        navigator.clipboard.writeText(currentGroup.payment_account).then(() => showToast('è´¦å·å·²å¤åˆ¶ï¼'));
    }

    function isDriver() {
        return currentGroup && currentGroup.driver_id === currentUser.id;
    }

    function getMyItems() {
        return items.filter(item => item.user_id === currentUser.id);
    }

    async function savePaymentInfo() {
        const driverName = $('driverName').value.trim();
        const method = $('paymentMethod').value;
        const account = $('paymentAccount').value.trim();
        const note = $('paymentNote').value.trim();
        const {error} = await db.from('groups').update({
            driver_name: driverName,
            payment_method: method,
            payment_account: account,
            payment_note: note
        }).eq('id', currentGroupId);
        if (error) { alert('ä¿å­˜å¤±è´¥ï¼š' + error.message); return; }
        currentGroup.driver_name = driverName;
        currentGroup.payment_method = method;
        currentGroup.payment_account = account;
        currentGroup.payment_note = note;
        updateDisplay();
        showToast('æ”¶æ¬¾ä¿¡æ¯å·²ä¿å­˜ï¼');
    }

    async function addItem() {
        const itemName = $('itemName').value.trim();
        const itemPrice = parseFloat($('itemPrice').value);
        if (!itemName) { alert('è¯·è¾“å…¥å•†å“åç§°'); return; }
        if (!itemPrice || itemPrice <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆä»·æ ¼'); return; }
        $('addItemBtn').disabled = true;
        const {error} = await db.from('items').insert({
            group_id: currentGroupId,
            name: itemName,
            price: itemPrice,
            user_id: currentUser.id,
            user_email: currentUser.email
        });
        $('addItemBtn').disabled = false;
        if (error) { alert('æ·»åŠ å¤±è´¥ï¼š' + error.message); return; }
        $('itemName').value = '';
        $('itemPrice').value = '';
        showToast('å·²æ·»åŠ ï¼');
    }

    async function removeItem(id) {
        const item = items.find(i => i.id === id);
        if (item.user_id !== currentUser.id && !isDriver()) {
            alert('åªèƒ½åˆ é™¤è‡ªå·±çš„å•†å“');
            return;
        }
        if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
        await db.from('items').delete().eq('id', id);
        // æ‰‹åŠ¨åˆ·æ–°
        await loadItems();
        updateDisplay();
    }

    async function togglePaid(id, current) {
        if (!isDriver()) return;
        await db.from('items').update({paid: !current}).eq('id', id);
    }

    function openCodeModal(id) {
        if (!isDriver()) return;
        const item = items.find(i => i.id === id);
        if (!item) return;
        editingItemId = id;
        $('modalItemName').textContent = item.name;
        $('modalItemOwner').textContent = item.user_email;
        $('codeInput').value = item.code || '';
        $('codeModal').classList.remove('hidden');
        $('codeInput').focus();
    }

    function closeCodeModal() {
        $('codeModal').classList.add('hidden');
        editingItemId = null;
    }

    async function saveCode() {
        const code = $('codeInput').value.trim();
        const {error} = await db.from('items').update({code: code}).eq('id', editingItemId);
        if (error) { alert('ä¿å­˜å¤±è´¥'); return; }
        closeCodeModal();
        showToast('å…‘æ¢ç å·²ä¿å­˜ï¼');
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code).then(() => showToast('å·²å¤åˆ¶ï¼'));
    }

    function getTotalPrice() {
        return items.reduce((sum, item) => sum + parseFloat(item.price), 0);
    }

    function getCurrentDiscount(total) {
        let d = 0;
        for (const t of discountTiers) if (total >= t.threshold) d = t.discount;
        return d;
    }

    function getNextTierInfo(total) {
        for (const t of discountTiers) {
            if (total < t.threshold) return {needed: t.threshold - total, threshold: t.threshold, discount: t.discount};
        }
        return null;
    }

    function calculatePerPerson(total, discount) {
        const perPerson = {};
        items.forEach(item => {
            const key = item.user_id;
            if (!perPerson[key]) perPerson[key] = {email: item.user_email, original: 0, items: [], allPaid: true};
            perPerson[key].original += parseFloat(item.price);
            perPerson[key].items.push(item);
            if (!item.paid) perPerson[key].allPaid = false;
        });
        const result = [];
        for (const userId in perPerson) {
            const ratio = perPerson[userId].original / total;
            const personDiscount = Math.round(discount * ratio * 100) / 100;
            const finalPay = Math.round((perPerson[userId].original - personDiscount) * 100) / 100;
            result.push({
                userId: userId,
                email: perPerson[userId].email,
                original: perPerson[userId].original,
                final: finalPay,
                allPaid: perPerson[userId].allPaid,
                items: perPerson[userId].items
            });
        }
        return result;
    }

    function updateDisplay() {
        const total = getTotalPrice();
        const discount = getCurrentDiscount(total);
        const nextTier = getNextTierInfo(total);
        const amDriver = isDriver();
        const perPersonData = items.length > 0 ? calculatePerPerson(total, discount) : [];
        const myItems = getMyItems();

        $('totalPrice').textContent = 'Â¥' + total;
        $('currentDiscount').textContent = '-Â¥' + discount;
        $('finalPrice').textContent = 'Â¥' + (total - discount);
        $('itemCount').textContent = items.length > 0 ? '(' + items.length + 'ä»¶)' : '';

        const nextTierEl = $('nextTierInfo');
        if (nextTier) {
            nextTierEl.innerHTML = 'å†åŠ  <span class="text-amber-300">Â¥' + nextTier.needed + '</span> å¯è¾¾åˆ°æ»¡' + nextTier.threshold + 'å‡' + nextTier.discount;
            nextTierEl.classList.remove('hidden');
        } else if (total >= 1000) {
            nextTierEl.innerHTML = 'ğŸ‰ å·²è¾¾åˆ°æœ€é«˜ä¼˜æƒ ï¼';
            nextTierEl.classList.remove('hidden');
        } else {
            nextTierEl.classList.add('hidden');
        }

        $('tierBadges').innerHTML = discountTiers.map(t =>
            '<span class="text-xs px-2 py-1 rounded ' + (total >= t.threshold ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400') + '">æ»¡' + t.threshold + 'å‡' + t.discount + '</span>'
        ).join('');

        // Payment info section
        $('paymentInfoSection').classList.remove('hidden');
        if (amDriver) {
            $('paymentEditMode').classList.remove('hidden');
            $('paymentViewMode').classList.add('hidden');
            $('driverName').value = currentGroup.driver_name || '';
            $('paymentMethod').value = currentGroup.payment_method || 'alipay';
            $('paymentAccount').value = currentGroup.payment_account || '';
            $('paymentNote').value = currentGroup.payment_note || '';
        } else {
            $('paymentEditMode').classList.add('hidden');
            if (currentGroup.payment_account) {
                $('paymentViewMode').classList.remove('hidden');
                $('viewDriverName').textContent = currentGroup.driver_name || 'æœªè®¾ç½®';
                const methodText = {alipay: 'æ”¯ä»˜å®', wechat: 'å¾®ä¿¡', both: 'æ”¯ä»˜å®/å¾®ä¿¡'};
                $('viewPaymentMethod').textContent = methodText[currentGroup.payment_method] || 'æ”¯ä»˜å®';
                $('viewPaymentAccount').textContent = currentGroup.payment_account;
                $('viewPaymentNote').textContent = currentGroup.payment_note || '';
            } else {
                $('paymentViewMode').classList.add('hidden');
            }
        }

        // Payment management (driver only)
        if (amDriver && items.length > 0) {
            $('paymentManageSection').classList.remove('hidden');
            const paidCount = perPersonData.filter(p => p.allPaid).length;
            let html = '<p class="text-sm text-gray-400 mb-2">å·²ä»˜æ¬¾ï¼š' + paidCount + '/' + perPersonData.length + ' äºº</p>';
            perPersonData.forEach(p => {
                html += '<div class="bg-gray-700 rounded p-3 mb-2">';
                html += '<div class="flex justify-between mb-2"><span>' + escapeHtml(p.email) + '</span><span class="text-amber-400">Â¥' + p.final + '</span></div>';
                html += '<div class="space-y-1">';
                p.items.forEach(item => {
                    html += '<div class="flex justify-between text-sm bg-gray-800 rounded px-2 py-1">';
                    html += '<span>' + escapeHtml(item.name) + '</span>';
                    html += '<button class="toggle-paid-btn px-2 py-0.5 rounded text-xs ' + (item.paid ? 'bg-green-600' : 'bg-gray-600') + '" data-id="' + item.id + '" data-paid="' + item.paid + '">' + (item.paid ? 'âœ“å·²ä»˜' : 'æœªä»˜') + '</button>';
                    html += '</div>';
                });
                html += '</div></div>';
            });
            $('paymentStatusList').innerHTML = html;
            document.querySelectorAll('.toggle-paid-btn').forEach(btn => {
                btn.addEventListener('click', () => togglePaid(parseInt(btn.dataset.id), btn.dataset.paid === 'true'));
            });
        } else {
            $('paymentManageSection').classList.add('hidden');
        }

        // My payment (non-driver)
        if (!amDriver && myItems.length > 0) {
            const myData = perPersonData.find(p => p.userId === currentUser.id);
            if (myData) {
                $('myPaymentSection').classList.remove('hidden');
                $('myPaymentAmount').textContent = 'Â¥' + myData.final;
                $('myPaymentStatus').innerHTML = myData.allPaid ? '<span class="text-green-400">âœ“ å·²ç¡®è®¤æ”¶æ¬¾</span>' : '<span class="text-yellow-400">â³ ç­‰å¾…ç¡®è®¤</span>';
                $('myPaymentStatus').className = 'text-center py-2 rounded ' + (myData.allPaid ? 'bg-green-800' : 'bg-yellow-800');
            }
        } else {
            $('myPaymentSection').classList.add('hidden');
        }

        // My codes (non-driver, only see own codes)
        if (!amDriver && myItems.length > 0) {
            const myItemsWithCode = myItems.filter(item => item.code);
            if (myItemsWithCode.length > 0) {
                $('myCodesSection').classList.remove('hidden');
                let html = '';
                myItemsWithCode.forEach(item => {
                    html += '<div class="bg-gray-800 rounded p-3">';
                    html += '<div class="text-sm text-gray-400 mb-1">' + escapeHtml(item.name) + '</div>';
                    html += '<div class="flex justify-between items-center">';
                    html += '<code class="text-green-400 font-mono text-sm">' + escapeHtml(item.code) + '</code>';
                    html += '<button class="copy-code-btn text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" data-code="' + escapeHtml(item.code) + '">å¤åˆ¶</button>';
                    html += '</div></div>';
                });
                $('myCodesList').innerHTML = html;
                document.querySelectorAll('.copy-code-btn').forEach(btn => {
                    btn.addEventListener('click', () => copyCode(btn.dataset.code));
                });
            } else {
                $('myCodesSection').classList.remove('hidden');
                $('myCodesList').innerHTML = '<p class="text-gray-400 text-sm">ç­‰å¾…è½¦å¤´å¡«å†™å…‘æ¢ç ...</p>';
            }
        } else {
            $('myCodesSection').classList.add('hidden');
        }

        // Per person section
        if (items.length > 0 && discount > 0) {
            $('perPersonSection').classList.remove('hidden');
            $('perPersonList').innerHTML = perPersonData.map(p =>
                '<div class="flex justify-between text-sm bg-gray-700 rounded px-3 py-2"><span>' + escapeHtml(p.email) + (p.allPaid ? ' <span class="text-green-400">âœ“</span>' : '') + '</span><span><span class="text-gray-400 line-through mr-2">Â¥' + p.original + '</span><span class="text-amber-400 font-bold">Â¥' + p.final + '</span></span></div>'
            ).join('');
        } else {
            $('perPersonSection').classList.add('hidden');
        }

        // Item list
        if (items.length === 0) {
            $('itemList').innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— å•†å“</p>';
        } else {
            let html = '';
            items.forEach(item => {
                const canDelete = item.user_id === currentUser.id || amDriver;
                const isMine = item.user_id === currentUser.id;
                html += '<div class="bg-gray-700 rounded p-3 ' + (isMine ? 'border border-amber-600' : '') + '">';
                html += '<div class="flex justify-between">';
                html += '<div><div class="font-medium">' + escapeHtml(item.name) + (item.paid ? ' <span class="text-green-400 text-xs">âœ“å·²ä»˜</span>' : '') + (isMine ? ' <span class="text-amber-400 text-xs">æˆ‘çš„</span>' : '') + '</div>';
                html += '<div class="text-sm text-gray-400">' + escapeHtml(item.user_email) + '</div></div>';
                html += '<div class="flex items-center gap-3"><span class="text-amber-400">Â¥' + item.price + '</span>';
                if (canDelete) {
                    html += '<button class="remove-item-btn text-red-400 hover:text-red-300 text-sm" data-id="' + item.id + '">åˆ é™¤</button>';
                }
                html += '</div></div>';
                if (amDriver) {
                    if (item.code) {
                        html += '<div class="mt-2 flex items-center gap-2"><span class="text-xs text-green-400">âœ“ å·²å¡«ç </span><button class="edit-code-btn text-xs text-blue-400" data-id="' + item.id + '">ç¼–è¾‘</button></div>';
                    } else {
                        html += '<button class="edit-code-btn mt-2 text-xs text-yellow-400" data-id="' + item.id + '">+ å¡«å†™å…‘æ¢ç </button>';
                    }
                }
                html += '</div>';
            });
            $('itemList').innerHTML = html;
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', () => removeItem(parseInt(btn.dataset.id)));
            });
            document.querySelectorAll('.edit-code-btn').forEach(btn => {
                btn.addEventListener('click', () => openCodeModal(parseInt(btn.dataset.id)));
            });
        }
    }

    function showToast(msg) {
        const t = $('toast');
        t.textContent = msg;
        t.classList.remove('hidden');
        setTimeout(() => t.classList.add('hidden'), 2000);
    }

    function showLoading(show) {
        $('loading').classList.toggle('hidden', !show);
    }

    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }
})();
</script>
</body>
</html>