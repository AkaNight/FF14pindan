<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 å•†åŸæ‹¼å•å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; }
    </style>
</head>
<body class="min-h-screen text-gray-100 p-4">
    <div class="max-w-lg mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6 text-amber-400">
            ğŸ›’ FF14 å•†åŸæ‹¼å•å·¥å…·
        </h1>

        <!-- èº«ä»½é€‰æ‹© -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-sm text-gray-400 mb-2">ä½ æ˜¯è°ï¼Ÿ</h3>
            <div class="flex gap-2 flex-wrap" id="identityButtons"></div>
            <p class="text-xs text-gray-500 mt-2">å½“å‰èº«ä»½ï¼š<span id="currentIdentity" class="text-amber-400">æœªé€‰æ‹©</span></p>
        </div>

        <!-- è½¦å¤´æ”¶æ¬¾ä¿¡æ¯ï¼ˆè½¦å¤´ç¼–è¾‘/ä¹˜å®¢æŸ¥çœ‹ï¼‰ -->
        <div id="paymentInfoSection" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3">ğŸ’° æ”¶æ¬¾ä¿¡æ¯</h2>
            <!-- è½¦å¤´ç¼–è¾‘æ¨¡å¼ -->
            <div id="paymentEditMode" class="hidden space-y-3">
                <input
                    type="text"
                    id="driverName"
                    placeholder="è½¦å¤´æ˜µç§°ï¼ˆå¦‚ï¼šå°æ˜ï¼‰"
                    class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500"
                >
                <select id="paymentMethod" class="w-full bg-gray-700 rounded px-3 py-2 text-white">
                    <option value="alipay">æ”¯ä»˜å®</option>
                    <option value="wechat">å¾®ä¿¡</option>
                    <option value="both">éƒ½å¯ä»¥</option>
                </select>
                <input
                    type="text"
                    id="paymentAccount"
                    placeholder="æ”¶æ¬¾è´¦å·/æ‰‹æœºå·"
                    class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500"
                >
                <textarea
                    id="paymentNote"
                    placeholder="å¤‡æ³¨ï¼ˆå¦‚ï¼šè½¬è´¦è¯·å¤‡æ³¨æ¸¸æˆIDï¼‰"
                    rows="2"
                    class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500"
                ></textarea>
                <button onclick="savePaymentInfo()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">
                    ä¿å­˜æ”¶æ¬¾ä¿¡æ¯
                </button>
            </div>
            <!-- ä¹˜å®¢æŸ¥çœ‹æ¨¡å¼ -->
            <div id="paymentViewMode" class="hidden">
                <div class="bg-gray-700 rounded p-3 space-y-2">
                    <p><span class="text-gray-400">è½¦å¤´ï¼š</span><span id="viewDriverName" class="text-white"></span></p>
                    <p><span class="text-gray-400">æ”¶æ¬¾æ–¹å¼ï¼š</span><span id="viewPaymentMethod" class="text-white"></span></p>
                    <p><span class="text-gray-400">è´¦å·ï¼š</span><span id="viewPaymentAccount" class="text-amber-400 font-mono"></span>
                        <button onclick="copyAccount()" class="ml-2 text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">å¤åˆ¶</button>
                    </p>
                    <p id="viewPaymentNote" class="text-sm text-gray-400"></p>
                </div>
            </div>
        </div>

        <!-- æˆ‘çš„ä»˜æ¬¾çŠ¶æ€ï¼ˆä¹˜å®¢è§†è§’ï¼‰ -->
        <div id="myPaymentSection" class="bg-blue-900 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3 text-blue-400">ğŸ’³ æˆ‘çš„ä»˜æ¬¾</h2>
            <div class="flex justify-between items-center mb-3">
                <span>åº”ä»˜é‡‘é¢ï¼š</span>
                <span id="myPaymentAmount" class="text-xl text-amber-400 font-bold">Â¥0</span>
            </div>
            <div id="myPaymentStatus" class="text-center py-2 rounded"></div>
        </div>

        <!-- æˆ‘çš„å…‘æ¢ç ï¼ˆä¹˜å®¢è§†è§’ï¼‰ -->
        <div id="myCodesSection" class="bg-green-900 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3 text-green-400">ğŸ æˆ‘çš„å…‘æ¢ç </h2>
            <div id="myCodesList" class="space-y-2"></div>
        </div>

        <!-- åˆ†äº«åŠŸèƒ½ -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex gap-2">
                <button onclick="generateShareLink()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">
                    ğŸ“¤ ç”Ÿæˆåˆ†äº«é“¾æ¥
                </button>
                <button onclick="clearAll()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded">
                    æ¸…ç©º
                </button>
            </div>
            <div id="shareResult" class="mt-3 hidden">
                <p class="text-sm text-gray-400 mb-2">é“¾æ¥å·²å¤åˆ¶ï¼å‘ç»™æœ‹å‹å³å¯ï¼š</p>
                <div class="bg-gray-700 rounded p-2 text-xs text-gray-300 break-all" id="shareLink"></div>
            </div>
        </div>

        <!-- ä»˜æ¬¾ç®¡ç†ï¼ˆè½¦å¤´è§†è§’ï¼‰ -->
        <div id="paymentManageSection" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3">ğŸ“‹ ä»˜æ¬¾ç®¡ç†</h2>
            <div id="paymentStatusList" class="space-y-2"></div>
        </div>

        <!-- ä»·æ ¼æ€»è§ˆ -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between mb-2">
                <span>å•†å“æ€»ä»·ï¼š</span>
                <span id="totalPrice" class="text-white font-bold">Â¥0</span>
            </div>
            <div class="flex justify-between mb-2">
                <span>å½“å‰ä¼˜æƒ ï¼š</span>
                <span id="currentDiscount" class="text-green-400 font-bold">-Â¥0</span>
            </div>
            <div class="border-t border-gray-700 my-2"></div>
            <div class="flex justify-between text-lg">
                <span>å®ä»˜é‡‘é¢ï¼š</span>
                <span id="finalPrice" class="text-amber-400 font-bold">Â¥0</span>
            </div>
            <div id="nextTierInfo" class="mt-3 text-sm text-gray-400 bg-gray-700 rounded p-2 hidden"></div>
            
            <div id="perPersonSection" class="mt-4 pt-4 border-t border-gray-700 hidden">
                <h3 class="text-sm text-gray-400 mb-2">æ¯äººåº”ä»˜ï¼ˆæŒ‰æ¯”ä¾‹åˆ†æ‘Šä¼˜æƒ ï¼‰ï¼š</h3>
                <div id="perPersonList" class="space-y-1"></div>
            </div>
        </div>

        <!-- ä¼˜æƒ æ¢¯åº¦å‚è€ƒ -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-sm text-gray-400 mb-2">ä¼˜æƒ æ¢¯åº¦ï¼š</h3>
            <div id="tierBadges" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-bold mb-3">å•†å“åˆ—è¡¨ <span id="itemCount" class="text-sm text-gray-400"></span></h2>
            <div id="itemList" class="space-y-2">
                <p class="text-gray-500 text-center py-4">æš‚æ— å•†å“</p>
            </div>
        </div>

        <!-- æ·»åŠ å•†å“ -->
        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-lg font-bold mb-3">æ·»åŠ å•†å“</h2>
            <div class="space-y-3">
                <input type="text" id="userName" placeholder="ä½ çš„æ˜µç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <input type="text" id="itemName" placeholder="å•†å“åç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <input type="number" id="itemPrice" placeholder="ä»·æ ¼" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <button onclick="addItem()" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 rounded">
                    â• æ·»åŠ åˆ°åˆ—è¡¨
                </button>
            </div>
        </div>

        <p class="text-center text-gray-600 text-sm mt-6">æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œç”Ÿæˆé“¾æ¥å¯åˆ†äº«ç»™æœ‹å‹</p>
    </div>

    <!-- æç¤ºå¼¹çª— -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden"></div>

    <!-- å…‘æ¢ç è¾“å…¥å¼¹çª— -->
    <div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold mb-2">å¡«å†™å…‘æ¢ç </h3>
            <p class="text-sm text-gray-400 mb-4">
                å•†å“ï¼š<span id="modalItemName" class="text-white"></span><br>
                æ‰€å±ï¼š<span id="modalItemOwner" class="text-amber-400"></span>
            </p>
            <input type="text" id="codeInput" placeholder="ç²˜è´´å…‘æ¢ç " class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500 mb-4">
            <div class="flex gap-2">
                <button onclick="saveCode()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">ä¿å­˜</button>
                <button onclick="closeCodeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let currentIdentity = null;
        let editingItemId = null;
        let paymentInfo = { driverName: '', method: 'alipay', account: '', note: '' };
        let paymentStatus = {}; // { "æ˜µç§°": true/false }
        
        const discountTiers = [
            { threshold: 50, discount: 10 },
            { threshold: 200, discount: 45 },
            { threshold: 400, discount: 100 },
            { threshold: 1000, discount: 300 },
        ];

        window.onload = function() {
            const urlData = getDataFromURL();
            if (urlData) {
                if (urlData.items) items = urlData.items;
                if (urlData.paymentInfo) paymentInfo = urlData.paymentInfo;
                if (urlData.paymentStatus) paymentStatus = urlData.paymentStatus;
                showToast('å·²åŠ è½½åˆ†äº«çš„æ‹¼å•æ•°æ®ï¼');
            } else {
                const saved = localStorage.getItem('ff14_data');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        items = data.items || [];
                        paymentInfo = data.paymentInfo || paymentInfo;
                        paymentStatus = data.paymentStatus || {};
                    } catch (e) {}
                }
            }
            
            const savedName = localStorage.getItem('ff14_username');
            if (savedName) document.getElementById('userName').value = savedName;
            
            updateIdentityButtons();
            updateDisplay();
        };

        function getDataFromURL() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if (data) {
                try {
                    return JSON.parse(decodeURIComponent(atob(data)));
                } catch (e) { return null; }
            }
            return null;
        }

        function getAllData() {
            return { items, paymentInfo, paymentStatus };
        }

        function generateShareLink() {
            if (items.length === 0) { alert('è¯·å…ˆæ·»åŠ å•†å“ï¼'); return; }
            const data = btoa(encodeURIComponent(JSON.stringify(getAllData())));
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = baseUrl + '?data=' + data;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                document.getElementById('shareLink').textContent = shareUrl;
                document.getElementById('shareResult').classList.remove('hidden');
                showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                document.getElementById('shareLink').textContent = shareUrl;
                document.getElementById('shareResult').classList.remove('hidden');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }

        function saveToLocal() {
            localStorage.setItem('ff14_data', JSON.stringify(getAllData()));
        }

        function updateIdentityButtons() {
            const container = document.getElementById('identityButtons');
            const owners = [...new Set(items.map(item => item.owner))];
            
            let html = `<button onclick="setIdentity('è½¦å¤´')" class="bg-amber-600 hover:bg-amber-500 text-white px-3 py-1 rounded text-sm">æˆ‘æ˜¯è½¦å¤´</button>`;
            owners.forEach(owner => {
                html += `<button onclick="setIdentity('${escapeHtml(owner)}')" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm">${escapeHtml(owner)}</button>`;
            });
            container.innerHTML = html;
        }

        function setIdentity(identity) {
            currentIdentity = identity;
            document.getElementById('currentIdentity').textContent = identity;
            if (identity !== 'è½¦å¤´') {
                document.getElementById('userName').value = identity;
                localStorage.setItem('ff14_username', identity);
            }
            updateDisplay();
            showToast(`å·²åˆ‡æ¢ä¸ºï¼š${identity}`);
        }

        function savePaymentInfo() {
            paymentInfo.driverName = document.getElementById('driverName').value.trim();
            paymentInfo.method = document.getElementById('paymentMethod').value;
            paymentInfo.account = document.getElementById('paymentAccount').value.trim();
            paymentInfo.note = document.getElementById('paymentNote').value.trim();
            saveToLocal();
            showToast('æ”¶æ¬¾ä¿¡æ¯å·²ä¿å­˜ï¼');
            document.getElementById('shareResult').classList.add('hidden');
        }

        function copyAccount() {
            navigator.clipboard.writeText(paymentInfo.account).then(() => showToast('è´¦å·å·²å¤åˆ¶ï¼'));
        }

        function togglePaymentStatus(owner) {
            paymentStatus[owner] = !paymentStatus[owner];
            saveToLocal();
            updateDisplay();
            document.getElementById('shareResult').classList.add('hidden');
        }

        function getTotalPrice() { return items.reduce((sum, item) => sum + item.price, 0); }

        function getCurrentDiscount(total) {
            let discount = 0;
            for (const tier of discountTiers) { if (total >= tier.threshold) discount = tier.discount; }
            return discount;
        }

        function getNextTierInfo(total) {
            for (const tier of discountTiers) {
                if (total < tier.threshold) return { needed: tier.threshold - total, threshold: tier.threshold, discount: tier.discount };
            }
            return null;
        }

        function calculatePerPerson(total, discount) {
            const perPerson = {};
            items.forEach(item => {
                if (!perPerson[item.owner]) perPerson[item.owner] = { original: 0, items: [] };
                perPerson[item.owner].original += item.price;
                perPerson[item.owner].items.push(item.name);
            });
            
            const result = [];
            for (const owner in perPerson) {
                const ratio = perPerson[owner].original / total;
                const personDiscount = Math.round(discount * ratio * 100) / 100;
                const finalPay = Math.round((perPerson[owner].original - personDiscount) * 100) / 100;
                result.push({ name: owner, original: perPerson[owner].original, discount: personDiscount, final: finalPay });
            }
            return result;
        }

        function addItem() {
            const userName = document.getElementById('userName').value.trim();
            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseFloat(document.getElementById('itemPrice').value);

            if (!userName) { alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°'); return; }
            if (!itemName) { alert('è¯·è¾“å…¥å•†å“åç§°'); return; }
            if (!itemPrice || itemPrice <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼'); return; }

            items.push({ id: Date.now(), name: itemName, price: itemPrice, owner: userName, code: '' });
            localStorage.setItem('ff14_username', userName);
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            saveToLocal();
            updateIdentityButtons();
            updateDisplay();
            document.getElementById('shareResult').classList.add('hidden');
        }

        function removeItem(id) {
            items = items.filter(item => item.id !== id);
            saveToLocal();
            updateIdentityButtons();
            updateDisplay();
            document.getElementById('shareResult').classList.add('hidden');
        }

        function openCodeModal(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            editingItemId = id;
            document.getElementById('modalItemName').textContent = item.name;
            document.getElementById('modalItemOwner').textContent = item.owner;
            document.getElementById('codeInput').value = item.code || '';
            document.getElementById('codeModal').classList.remove('hidden');
            document.getElementById('codeInput').focus();
        }

        function closeCodeModal() {
            document.getElementById('codeModal').classList.add('hidden');
            editingItemId = null;
        }

        function saveCode() {
            const code = document.getElementById('codeInput').value.trim();
            const item = items.find(i => i.id === editingItemId);
            if (item) { item.code = code; saveToLocal(); updateDisplay(); showToast('å…‘æ¢ç å·²ä¿å­˜ï¼'); }
            closeCodeModal();
            document.getElementById('shareResult').classList.add('hidden');
        }

        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => showToast('å…‘æ¢ç å·²å¤åˆ¶ï¼'));
        }

        function clearAll() {
            if (items.length === 0) return;
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                items = [];
                paymentStatus = {};
                saveToLocal();
                updateIdentityButtons();
                updateDisplay();
                document.getElementById('shareResult').classList.add('hidden');
                window.history.replaceState({}, '', window.location.pathname);
            }
        }

        function updateDisplay() {
            const total = getTotalPrice();
            const discount = getCurrentDiscount(total);
            const nextTier = getNextTierInfo(total);
            const isDriver = currentIdentity === 'è½¦å¤´';
            const perPersonData = items.length > 0 ? calculatePerPerson(total, discount) : [];

            // ä»·æ ¼æ˜¾ç¤º
            document.getElementById('totalPrice').textContent = 'Â¥' + total;
            document.getElementById('currentDiscount').textContent = '-Â¥' + discount;
            document.getElementById('finalPrice').textContent = 'Â¥' + (total - discount);
            document.getElementById('itemCount').textContent = items.length > 0 ? `(${items.length}ä»¶)` : '';

            // ä¸‹ä¸€æ¡£æç¤º
            const nextTierEl = document.getElementById('nextTierInfo');
            if (nextTier) {
                nextTierEl.innerHTML = `å†åŠ  <span class="text-amber-300">Â¥${nextTier.needed}</span> å¯è¾¾åˆ°æ»¡${nextTier.threshold}å‡${nextTier.discount}`;
                nextTierEl.classList.remove('hidden');
            } else if (total >= 1000) {
                nextTierEl.innerHTML = `ğŸ‰ å·²è¾¾åˆ°æœ€é«˜ä¼˜æƒ æ¡£ä½ï¼`;
                nextTierEl.classList.remove('hidden');
            } else {
                nextTierEl.classList.add('hidden');
            }

            // ä¼˜æƒ æ¢¯åº¦
            document.getElementById('tierBadges').innerHTML = discountTiers.map(tier => 
                `<span class="text-xs px-2 py-1 rounded ${total >= tier.threshold ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}">æ»¡${tier.threshold}å‡${tier.discount}</span>`
            ).join('');

            // æ”¶æ¬¾ä¿¡æ¯åŒºåŸŸ
            const paymentInfoSection = document.getElementById('paymentInfoSection');
            const paymentEditMode = document.getElementById('paymentEditMode');
            const paymentViewMode = document.getElementById('paymentViewMode');
            
            if (currentIdentity) {
                paymentInfoSection.classList.remove('hidden');
                if (isDriver) {
                    paymentEditMode.classList.remove('hidden');
                    paymentViewMode.classList.add('hidden');
                    document.getElementById('driverName').value = paymentInfo.driverName;
                    document.getElementById('paymentMethod').value = paymentInfo.method;
                    document.getElementById('paymentAccount').value = paymentInfo.account;
                    document.getElementById('paymentNote').value = paymentInfo.note;
                } else {
                    paymentEditMode.classList.add('hidden');
                    if (paymentInfo.account) {
                        paymentViewMode.classList.remove('hidden');
                        document.getElementById('viewDriverName').textContent = paymentInfo.driverName || 'æœªè®¾ç½®';
                        const methodText = { alipay: 'æ”¯ä»˜å®', wechat: 'å¾®ä¿¡', both: 'æ”¯ä»˜å®/å¾®ä¿¡' };
                        document.getElementById('viewPaymentMethod').textContent = methodText[paymentInfo.method];
                        document.getElementById('viewPaymentAccount').textContent = paymentInfo.account;
                        document.getElementById('viewPaymentNote').textContent = paymentInfo.note || '';
                    } else {
                        paymentViewMode.classList.add('hidden');
                    }
                }
            } else {
                paymentInfoSection.classList.add('hidden');
            }

            // ä»˜æ¬¾ç®¡ç†ï¼ˆè½¦å¤´è§†è§’ï¼‰
            const paymentManageSection = document.getElementById('paymentManageSection');
            if (isDriver && items.length > 0) {
                paymentManageSection.classList.remove('hidden');
                const paidCount = perPersonData.filter(p => paymentStatus[p.name]).length;
                document.getElementById('paymentStatusList').innerHTML = 
                    `<p class="text-sm text-gray-400 mb-2">å·²ä»˜æ¬¾ï¼š${paidCount}/${perPersonData.length} äºº</p>` +
                    perPersonData.map(p => `
                        <div class="flex items-center justify-between bg-gray-700 rounded p-3">
                            <div>
                                <span class="font-medium">${escapeHtml(p.name)}</span>
                                <span class="text-amber-400 ml-2">Â¥${p.final}</span>
                            </div>
                            <button onclick="togglePaymentStatus('${escapeHtml(p.name)}')" class="px-3 py-1 rounded text-sm ${paymentStatus[p.name] ? 'bg-green-600 text-white' : 'bg-gray-600 text-gray-300'}">
                                ${paymentStatus[p.name] ? 'âœ“ å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
                            </button>
                        </div>
                    `).join('');
            } else {
                paymentManageSection.classList.add('hidden');
            }

            // æˆ‘çš„ä»˜æ¬¾çŠ¶æ€ï¼ˆä¹˜å®¢è§†è§’ï¼‰
            const myPaymentSection = document.getElementById('myPaymentSection');
            if (currentIdentity && !isDriver) {
                const myData = perPersonData.find(p => p.name === currentIdentity);
                if (myData) {
                    myPaymentSection.classList.remove('hidden');
                    document.getElementById('myPaymentAmount').textContent = 'Â¥' + myData.final;
                    const isPaid = paymentStatus[currentIdentity];
                    document.getElementById('myPaymentStatus').innerHTML = isPaid 
                        ? '<span class="text-green-400">âœ“ è½¦å¤´å·²ç¡®è®¤æ”¶æ¬¾</span>'
                        : '<span class="text-yellow-400">â³ ç­‰å¾…è½¦å¤´ç¡®è®¤...</span>';
                    document.getElementById('myPaymentStatus').className = `text-center py-2 rounded ${isPaid ? 'bg-green-800' : 'bg-yellow-800'}`;
                } else {
                    myPaymentSection.classList.add('hidden');
                }
            } else {
                myPaymentSection.classList.add('hidden');
            }

            // æˆ‘çš„å…‘æ¢ç ï¼ˆä¹˜å®¢è§†è§’ï¼‰
            const myCodesSection = document.getElementById('myCodesSection');
            const myCodesList = document.getElementById('myCodesList');
            if (currentIdentity && !isDriver) {
                const myItems = items.filter(item => item.owner === currentIdentity);
                const myItemsWithCode = myItems.filter(item => item.code);
                if (myItemsWithCode.length > 0) {
                    myCodesSection.classList.remove('hidden');
                    myCodesList.innerHTML = myItemsWithCode.map(item => `
                        <div class="bg-gray-800 rounded p-3">
                            <div class="text-sm text-gray-400 mb-1">${escapeHtml(item.name)}</div>
                            <div class="flex items-center justify-between">
                                <code class="text-green-400 font-mono text-sm">${escapeHtml(item.code)}</code>
                                <button onclick="copyCode('${escapeHtml(item.code)}')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">å¤åˆ¶</button>
                            </div>
                        </div>
                    `).join('');
                } else if (myItems.length > 0) {
                    myCodesSection.classList.remove('hidden');
                    myCodesList.innerHTML = '<p class="text-gray-400 text-sm">è½¦å¤´è¿˜æ²¡å¡«å†™ä½ çš„å…‘æ¢ç ï¼Œè¯·ç¨ç­‰~</p>';
                } else {
                    myCodesSection.classList.add('hidden');
                }
            } else {
                myCodesSection.classList.add('hidden');
            }

            // æ¯äººåº”ä»˜
            const perPersonSection = document.getElementById('perPersonSection');
            const perPersonList = document.getElementById('perPersonList');
            if (items.length > 0 && discount > 0) {
                perPersonSection.classList.remove('hidden');
                perPersonList.innerHTML = perPersonData.map(p => `
                    <div class="flex justify-between text-sm bg-gray-700 rounded px-3 py-2">
                        <span>${escapeHtml(p.name)} ${paymentStatus[p.name] ? '<span class="text-green-400">âœ“</span>' : ''}</span>
                        <span>
                            <span class="text-gray-400 line-through mr-2">Â¥${p.original}</span>
                            <span class="text-amber-400 font-bold">Â¥${p.final}</span>
                        </span>
                    </div>
                `).join('');
            } else {
                perPersonSection.classList.add('hidden');
            }

            // å•†å“åˆ—è¡¨
            const itemListEl = document.getElementById('itemList');
            if (items.length === 0) {
                itemListEl.innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— å•†å“ï¼Œæ·»åŠ ç¬¬ä¸€ä»¶å§ï¼</p>';
            } else {
                itemListEl.innerHTML = items.map(item => {
                    let codeSection = '';
                    if (isDriver) {
                        codeSection = item.code
                            ? `<div class="mt-2 flex items-center gap-2"><span class="text-xs text-green-400">âœ“ å·²å¡«ç </span><button onclick="openCodeModal(${item.id})" class="text-xs text-blue-400 hover:text-blue-300">ç¼–è¾‘</button></div>`
                            : `<button onclick="openCodeModal(${item.id})" class="mt-2 text-xs text-yellow-400 hover:text-yellow-300">+ å¡«å†™å…‘æ¢ç </button>`;
                    }
                    return `
                        <div class="bg-gray-700 rounded p-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">${escapeHtml(item.name)}</div>
                                    <div class="text-sm text-gray-400">${escapeHtml(item.owner)}</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-amber-400">Â¥${item.price}</span>
                                    <button onclick="removeItem(${item.id})" class="text-red-400 hover:text-red-300 text-sm">åˆ é™¤</button>
                                </div>
                            </div>
                            ${codeSection}
                        </div>
                    `;
                }).join('');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>