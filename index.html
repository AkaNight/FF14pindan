<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF14 å•†åŸæ‹¼å•å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body{background-color:#111827}</style>
</head>
<body class="min-h-screen text-gray-100 p-4">
<div class="max-w-lg mx-auto">
    <h1 class="text-2xl font-bold text-center mb-2 text-amber-400">ğŸ›’ FF14 å•†åŸæ‹¼å•</h1>
    <p class="text-center text-gray-500 text-sm mb-6">æ•°æ®å®æ—¶åŒæ­¥ï¼Œåˆ·æ–°å³å¯çœ‹åˆ°æœ€æ–°çŠ¶æ€</p>

    <div id="homePage">
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">ğŸš— åˆ›å»ºæ–°è½¦é˜Ÿ</h2>
            <p class="text-gray-400 text-sm mb-4">ä½ å°†æˆä¸ºè½¦å¤´ï¼Œå¯ä»¥ç®¡ç†ä»˜æ¬¾å’Œå…‘æ¢ç </p>
            <button onclick="createGroup()" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded">å¼€ä¸€è¾†æ–°è½¦</button>
        </div>
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-lg font-bold mb-4">ğŸ« åŠ å…¥è½¦é˜Ÿ</h2>
            <p class="text-gray-400 text-sm mb-4">è¾“å…¥è½¦å¤´åˆ†äº«ç»™ä½ çš„è½¦é˜ŸID</p>
            <input type="text" id="joinGroupId" placeholder="è½¦é˜ŸIDï¼ˆ6ä½å­—ç¬¦ï¼‰" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500 mb-3 uppercase" maxlength="6">
            <button onclick="joinGroup()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded">åŠ å…¥è½¦é˜Ÿ</button>
        </div>
        <div id="recentGroups" class="mt-6 hidden">
            <h3 class="text-gray-400 text-sm mb-2">æœ€è¿‘å‚ä¸çš„è½¦é˜Ÿï¼š</h3>
            <div id="recentGroupList" class="space-y-2"></div>
        </div>
    </div>

    <div id="groupPage" class="hidden">
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <span class="text-gray-400 text-sm">è½¦é˜ŸIDï¼š</span>
                    <span id="groupIdDisplay" class="font-mono text-amber-400 text-lg"></span>
                    <button onclick="copyGroupLink()" class="ml-2 text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">å¤åˆ¶é“¾æ¥</button>
                </div>
                <button onclick="goHome()" class="text-gray-400 hover:text-white text-sm">â† è¿”å›</button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-sm text-gray-400 mb-2">ä½ æ˜¯è°ï¼Ÿ</h3>
            <div class="flex gap-2 flex-wrap" id="identityButtons"></div>
            <p class="text-xs text-gray-500 mt-2">å½“å‰èº«ä»½ï¼š<span id="currentIdentity" class="text-amber-400">æœªé€‰æ‹©</span></p>
        </div>

        <div id="paymentInfoSection" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3">ğŸ’° æ”¶æ¬¾ä¿¡æ¯</h2>
            <div id="paymentEditMode" class="hidden space-y-3">
                <input type="text" id="driverName" placeholder="è½¦å¤´æ˜µç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <select id="paymentMethod" class="w-full bg-gray-700 rounded px-3 py-2 text-white">
                    <option value="alipay">æ”¯ä»˜å®</option>
                    <option value="wechat">å¾®ä¿¡</option>
                    <option value="both">éƒ½å¯ä»¥</option>
                </select>
                <input type="text" id="paymentAccount" placeholder="æ”¶æ¬¾è´¦å·/æ‰‹æœºå·" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <textarea id="paymentNote" placeholder="å¤‡æ³¨" rows="2" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500"></textarea>
                <button onclick="savePaymentInfo()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">ä¿å­˜æ”¶æ¬¾ä¿¡æ¯</button>
            </div>
            <div id="paymentViewMode" class="hidden bg-gray-700 rounded p-3 space-y-2">
                <p><span class="text-gray-400">è½¦å¤´ï¼š</span><span id="viewDriverName"></span></p>
                <p><span class="text-gray-400">æ”¶æ¬¾æ–¹å¼ï¼š</span><span id="viewPaymentMethod"></span></p>
                <p><span class="text-gray-400">è´¦å·ï¼š</span><span id="viewPaymentAccount" class="text-amber-400 font-mono"></span>
                    <button onclick="copyAccount()" class="ml-2 text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">å¤åˆ¶</button></p>
                <p id="viewPaymentNote" class="text-sm text-gray-400"></p>
            </div>
        </div>

        <div id="myPaymentSection" class="bg-blue-900 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3 text-blue-400">ğŸ’³ æˆ‘çš„ä»˜æ¬¾</h2>
            <div class="flex justify-between items-center mb-3">
                <span>åº”ä»˜é‡‘é¢ï¼š</span>
                <span id="myPaymentAmount" class="text-xl text-amber-400 font-bold">Â¥0</span>
            </div>
            <div id="myPaymentStatus" class="text-center py-2 rounded"></div>
        </div>

        <div id="myCodesSection" class="bg-green-900 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3 text-green-400">ğŸ æˆ‘çš„å…‘æ¢ç </h2>
            <div id="myCodesList" class="space-y-2"></div>
        </div>

        <div id="paymentManageSection" class="bg-gray-800 rounded-lg p-4 mb-6 hidden">
            <h2 class="text-lg font-bold mb-3">ğŸ“‹ ä»˜æ¬¾ç®¡ç†</h2>
            <div id="paymentStatusList" class="space-y-2"></div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between mb-2"><span>å•†å“æ€»ä»·ï¼š</span><span id="totalPrice" class="text-white font-bold">Â¥0</span></div>
            <div class="flex justify-between mb-2"><span>å½“å‰ä¼˜æƒ ï¼š</span><span id="currentDiscount" class="text-green-400 font-bold">-Â¥0</span></div>
            <div class="border-t border-gray-700 my-2"></div>
            <div class="flex justify-between text-lg"><span>å®ä»˜é‡‘é¢ï¼š</span><span id="finalPrice" class="text-amber-400 font-bold">Â¥0</span></div>
            <div id="nextTierInfo" class="mt-3 text-sm text-gray-400 bg-gray-700 rounded p-2 hidden"></div>
            <div id="perPersonSection" class="mt-4 pt-4 border-t border-gray-700 hidden">
                <h3 class="text-sm text-gray-400 mb-2">æ¯äººåº”ä»˜ï¼š</h3>
                <div id="perPersonList" class="space-y-1"></div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-sm text-gray-400 mb-2">ä¼˜æƒ æ¢¯åº¦ï¼š</h3>
            <div id="tierBadges" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-bold mb-3">å•†å“åˆ—è¡¨ <span id="itemCount" class="text-sm text-gray-400"></span></h2>
            <div id="itemList" class="space-y-2"><p class="text-gray-500 text-center py-4">æš‚æ— å•†å“</p></div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-lg font-bold mb-3">æ·»åŠ å•†å“</h2>
            <div class="space-y-3">
                <input type="text" id="userName" placeholder="ä½ çš„æ˜µç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <input type="text" id="itemName" placeholder="å•†å“åç§°" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <input type="number" id="itemPrice" placeholder="ä»·æ ¼" class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500">
                <button onclick="addItem()" id="addItemBtn" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 rounded">â• æ·»åŠ åˆ°åˆ—è¡¨</button>
            </div>
        </div>
    </div>
    <p class="text-center text-gray-600 text-sm mt-6">FF14å•†åŸæ‹¼å•å·¥å…·</p>
</div>

<div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden z-50"></div>

<div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
        <h3 class="text-lg font-bold mb-2">å¡«å†™å…‘æ¢ç </h3>
        <p class="text-sm text-gray-400 mb-4">å•†å“ï¼š<span id="modalItemName" class="text-white"></span><br>æ‰€å±ï¼š<span id="modalItemOwner" class="text-amber-400"></span></p>
        <input type="text" id="codeInput" placeholder="ç²˜è´´å…‘æ¢ç " class="w-full bg-gray-700 rounded px-3 py-2 text-white placeholder-gray-500 mb-4">
        <div class="flex gap-2">
            <button onclick="saveCode()" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">ä¿å­˜</button>
            <button onclick="closeCodeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-400 mx-auto mb-4"></div>
        <p class="text-gray-400">åŠ è½½ä¸­...</p>
    </div>
</div>

<script>
const SUPABASE_URL='https://qeoyhijdiykcmdwdrqel.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlb3loaWpkaXlrY21kd2RycWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2ODg3NTEsImV4cCI6MjA4NjI2NDc1MX0.wTeG9XQMv3ui5D1fRjqXDSJDLoWwBr0E730kIlEfN0w';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let currentGroupId=null,currentGroup=null,items=[],currentIdentity=null,editingItemId=null;
const discountTiers=[{threshold:50,discount:10},{threshold:200,discount:45},{threshold:400,discount:100},{threshold:1000,discount:300}];

window.onload=function(){
    const params=new URLSearchParams(window.location.search);
    const groupId=params.get('g');
    if(groupId)loadGroup(groupId);else showHomePage();
    loadRecentGroups();
    const savedName=localStorage.getItem('ff14_username');
    if(savedName)document.getElementById('userName').value=savedName;
};

function showHomePage(){document.getElementById('homePage').classList.remove('hidden');document.getElementById('groupPage').classList.add('hidden');currentGroupId=null;currentGroup=null;items=[];}
function goHome(){window.history.pushState({},'',window.location.pathname);showHomePage();}
function generateId(){const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let id='';for(let i=0;i<6;i++)id+=chars.charAt(Math.floor(Math.random()*chars.length));return id;}

async function createGroup(){
    showLoading(true);
    const groupId=generateId();
    const{error}=await supabase.from('groups').insert({id:groupId});
    if(error){showLoading(false);alert('åˆ›å»ºå¤±è´¥ï¼š'+error.message);return;}
    saveRecentGroup(groupId);
    await loadGroup(groupId);
    showToast('è½¦é˜Ÿåˆ›å»ºæˆåŠŸï¼');
}

async function joinGroup(){
    const groupId=document.getElementById('joinGroupId').value.trim().toUpperCase();
    if(!groupId||groupId.length!==6){alert('è¯·è¾“å…¥6ä½è½¦é˜ŸID');return;}
    await loadGroup(groupId);
}

async function loadGroup(groupId){
    showLoading(true);
    const{data:group,error:groupError}=await supabase.from('groups').select('*').eq('id',groupId).single();
    if(groupError||!group){showLoading(false);alert('è½¦é˜Ÿä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');return;}
    currentGroupId=groupId;currentGroup=group;
    window.history.pushState({},'',`?g=${groupId}`);
    await loadItems();
    subscribeToChanges();
    saveRecentGroup(groupId);
    document.getElementById('homePage').classList.add('hidden');
    document.getElementById('groupPage').classList.remove('hidden');
    document.getElementById('groupIdDisplay').textContent=groupId;
    updateIdentityButtons();updateDisplay();showLoading(false);
}

async function loadItems(){
    const{data,error}=await supabase.from('items').select('*').eq('group_id',currentGroupId).order('created_at',{ascending:true});
    if(!error)items=data||[];
}

function subscribeToChanges(){
    supabase.channel(`group-${currentGroupId}`)
    .on('postgres_changes',{event:'*',schema:'public',table:'items',filter:`group_id=eq.${currentGroupId}`},()=>{loadItems().then(()=>{updateIdentityButtons();updateDisplay();});})
    .on('postgres_changes',{event:'*',schema:'public',table:'groups',filter:`id=eq.${currentGroupId}`},async()=>{const{data}=await supabase.from('groups').select('*').eq('id',currentGroupId).single();if(data)currentGroup=data;updateDisplay();})
    .subscribe();
}

function saveRecentGroup(groupId){let recent=JSON.parse(localStorage.getItem('ff14_recent_groups')||'[]');recent=recent.filter(id=>id!==groupId);recent.unshift(groupId);recent=recent.slice(0,5);localStorage.setItem('ff14_recent_groups',JSON.stringify(recent));loadRecentGroups();}

function loadRecentGroups(){
    const recent=JSON.parse(localStorage.getItem('ff14_recent_groups')||'[]');
    const container=document.getElementById('recentGroups');
    const list=document.getElementById('recentGroupList');
    if(recent.length>0){container.classList.remove('hidden');list.innerHTML=recent.map(id=>`<button onclick="loadGroup('${id}')" class="w-full text-left bg-gray-800 hover:bg-gray-700 rounded p-3 text-sm"><span class="font-mono text-amber-400">${id}</span></button>`).join('');}
    else{container.classList.add('hidden');}
}

function copyGroupLink(){const link=`${window.location.origin}${window.location.pathname}?g=${currentGroupId}`;navigator.clipboard.writeText(link).then(()=>showToast('é“¾æ¥å·²å¤åˆ¶ï¼'));}
function copyAccount(){navigator.clipboard.writeText(currentGroup.payment_account).then(()=>showToast('è´¦å·å·²å¤åˆ¶ï¼'));}

function setIdentity(identity){
    currentIdentity=identity;
    document.getElementById('currentIdentity').textContent=identity;
    if(identity!=='è½¦å¤´'){document.getElementById('userName').value=identity;localStorage.setItem('ff14_username',identity);}
    updateDisplay();
}

function updateIdentityButtons(){
    const container=document.getElementById('identityButtons');
    const owners=[...new Set(items.map(item=>item.owner))];
    let html=`<button onclick="setIdentity('è½¦å¤´')" class="bg-amber-600 hover:bg-amber-500 text-white px-3 py-1 rounded text-sm">æˆ‘æ˜¯è½¦å¤´</button>`;
    owners.forEach(owner=>{html+=`<button onclick="setIdentity('${escapeHtml(owner)}')" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm">${escapeHtml(owner)}</button>`;});
    container.innerHTML=html;
}

async function savePaymentInfo(){
    const driverName=document.getElementById('driverName').value.trim();
    const method=document.getElementById('paymentMethod').value;
    const account=document.getElementById('paymentAccount').value.trim();
    const note=document.getElementById('paymentNote').value.trim();
    const{error}=await supabase.from('groups').update({driver_name:driverName,payment_method:method,payment_account:account,payment_note:note}).eq('id',currentGroupId);
    if(error){alert('ä¿å­˜å¤±è´¥ï¼š'+error.message);return;}
    currentGroup.driver_name=driverName;currentGroup.payment_method=method;currentGroup.payment_account=account;currentGroup.payment_note=note;
    updateDisplay();showToast('æ”¶æ¬¾ä¿¡æ¯å·²ä¿å­˜ï¼');
}

async function addItem(){
    const userName=document.getElementById('userName').value.trim();
    const itemName=document.getElementById('itemName').value.trim();
    const itemPrice=parseFloat(document.getElementById('itemPrice').value);
    if(!userName){alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°');return;}
    if(!itemName){alert('è¯·è¾“å…¥å•†å“åç§°');return;}
    if(!itemPrice||itemPrice<=0){alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼');return;}
    document.getElementById('addItemBtn').disabled=true;
    const{error}=await supabase.from('items').insert({group_id:currentGroupId,name:itemName,price:itemPrice,owner:userName});
    document.getElementById('addItemBtn').disabled=false;
    if(error){alert('æ·»åŠ å¤±è´¥ï¼š'+error.message);return;}
    localStorage.setItem('ff14_username',userName);
    document.getElementById('itemName').value='';document.getElementById('itemPrice').value='';
    showToast('å•†å“å·²æ·»åŠ ï¼');
}

async function removeItem(id){if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;await supabase.from('items').delete().eq('id',id);}
async function togglePaid(id,currentStatus){await supabase.from('items').update({paid:!currentStatus}).eq('id',id);}

function openCodeModal(id){
    const item=items.find(i=>i.id===id);if(!item)return;
    editingItemId=id;
    document.getElementById('modalItemName').textContent=item.name;
    document.getElementById('modalItemOwner').textContent=item.owner;
    document.getElementById('codeInput').value=item.code||'';
    document.getElementById('codeModal').classList.remove('hidden');
    document.getElementById('codeInput').focus();
}
function closeCodeModal(){document.getElementById('codeModal').classList.add('hidden');editingItemId=null;}

async function saveCode(){
    const code=document.getElementById('codeInput').value.trim();
    const{error}=await supabase.from('items').update({code}).eq('id',editingItemId);
    if(error){alert('ä¿å­˜å¤±è´¥ï¼š'+error.message);return;}
    closeCodeModal();showToast('å…‘æ¢ç å·²ä¿å­˜ï¼');
}

function copyCode(code){navigator.clipboard.writeText(code).then(()=>showToast('å…‘æ¢ç å·²å¤åˆ¶ï¼'));}

function getTotalPrice(){return items.reduce((sum,item)=>sum+parseFloat(item.price),0);}
function getCurrentDiscount(total){let d=0;for(const t of discountTiers)if(total>=t.threshold)d=t.discount;return d;}
function getNextTierInfo(total){for(const t of discountTiers)if(total<t.threshold)return{needed:t.threshold-total,threshold:t.threshold,discount:t.discount};return null;}

function calculatePerPerson(total,discount){
    const perPerson={};
    items.forEach(item=>{
        if(!perPerson[item.owner])perPerson[item.owner]={original:0,items:[],allPaid:true};
        perPerson[item.owner].original+=parseFloat(item.price);
        perPerson[item.owner].items.push(item);
        if(!item.paid)perPerson[item.owner].allPaid=false;
    });
    const result=[];
    for(const owner in perPerson){
        const ratio=perPerson[owner].original/total;
        const personDiscount=Math.round(discount*ratio*100)/100;
        const finalPay=Math.round((perPerson[owner].original-personDiscount)*100)/100;
        result.push({name:owner,original:perPerson[owner].original,final:finalPay,allPaid:perPerson[owner].allPaid,items:perPerson[owner].items});
    }
    return result;
}

function updateDisplay(){
    const total=getTotalPrice();
    const discount=getCurrentDiscount(total);
    const nextTier=getNextTierInfo(total);
    const isDriver=currentIdentity==='è½¦å¤´';
    const perPersonData=items.length>0?calculatePerPerson(total,discount):[];

    document.getElementById('totalPrice').textContent='Â¥'+total;
    document.getElementById('currentDiscount').textContent='-Â¥'+discount;
    document.getElementById('finalPrice').textContent='Â¥'+(total-discount);
    document.getElementById('itemCount').textContent=items.length>0?`(${items.length}ä»¶)`:'';

    const nextTierEl=document.getElementById('nextTierInfo');
    if(nextTier){nextTierEl.innerHTML=`å†åŠ  <span class="text-amber-300">Â¥${nextTier.needed}</span> å¯è¾¾åˆ°æ»¡${nextTier.threshold}å‡${nextTier.discount}`;nextTierEl.classList.remove('hidden');}
    else if(total>=1000){nextTierEl.innerHTML=`ğŸ‰ å·²è¾¾åˆ°æœ€é«˜ä¼˜æƒ æ¡£ä½ï¼`;nextTierEl.classList.remove('hidden');}
    else{nextTierEl.classList.add('hidden');}

    document.getElementById('tierBadges').innerHTML=discountTiers.map(t=>`<span class="text-xs px-2 py-1 rounded ${total>=t.threshold?'bg-green-600 text-white':'bg-gray-700 text-gray-400'}">æ»¡${t.threshold}å‡${t.discount}</span>`).join('');

    const paymentInfoSection=document.getElementById('paymentInfoSection');
    const paymentEditMode=document.getElementById('paymentEditMode');
    const paymentViewMode=document.getElementById('paymentViewMode');
    if(currentIdentity){
        paymentInfoSection.classList.remove('hidden');
        if(isDriver){
            paymentEditMode.classList.remove('hidden');paymentViewMode.classList.add('hidden');
            document.getElementById('driverName').value=currentGroup.driver_name||'';
            document.getElementById('paymentMethod').value=currentGroup.payment_method||'alipay';
            document.getElementById('paymentAccount').value=currentGroup.payment_account||'';
            document.getElementById('paymentNote').value=currentGroup.payment_note||'';
        }else{
            paymentEditMode.classList.add('hidden');
            if(currentGroup.payment_account){
                paymentViewMode.classList.remove('hidden');
                document.getElementById('viewDriverName').textContent=currentGroup.driver_name||'æœªè®¾ç½®';
                const methodText={alipay:'æ”¯ä»˜å®',wechat:'å¾®ä¿¡',both:'æ”¯ä»˜å®/å¾®ä¿¡'};
                document.getElementById('viewPaymentMethod').textContent=methodText[currentGroup.payment_method]||'æ”¯ä»˜å®';
                document.getElementById('viewPaymentAccount').textContent=currentGroup.payment_account;
                document.getElementById('viewPaymentNote').textContent=currentGroup.payment_note||'';
            }else{paymentViewMode.classList.add('hidden');}
        }
    }else{paymentInfoSection.classList.add('hidden');}

    const paymentManageSection=document.getElementById('paymentManageSection');
    if(isDriver&&items.length>0){
        paymentManageSection.classList.remove('hidden');
        const paidCount=perPersonData.filter(p=>p.allPaid).length;
        document.getElementById('paymentStatusList').innerHTML=`<p class="text-sm text-gray-400 mb-2">å·²ä»˜æ¬¾ï¼š${paidCount}/${perPersonData.length} äºº</p>`+perPersonData.map(p=>`
            <div class="bg-gray-700 rounded p-3">
                <div class="flex items-center justify-between mb-2"><span class="font-medium">${escapeHtml(p.name)}</span><span class="text-amber-400">Â¥${p.final}</span></div>
                <div class="space-y-1">${p.items.map(item=>`<div class="flex items-center justify-between text-sm bg-gray-800 rounded px-2 py-1"><span class="text-gray-300">${escapeHtml(item.name)}</span><button onclick="togglePaid(${item.id},${item.paid})" class="px-2 py-0.5 rounded text-xs ${item.paid?'bg-green-600':'bg-gray-600'}">${item.paid?'âœ“ å·²ä»˜':'æœªä»˜'}</button></div>`).join('')}</div>
            </div>`).join('');
    }else{paymentManageSection.classList.add('hidden');}

    const myPaymentSection=document.getElementById('myPaymentSection');
    if(currentIdentity&&!isDriver){
        const myData=perPersonData.find(p=>p.name===currentIdentity);
        if(myData){
            myPaymentSection.classList.remove('hidden');
            document.getElementById('myPaymentAmount').textContent='Â¥'+myData.final;
            document.getElementById('myPaymentStatus').innerHTML=myData.allPaid?'<span class="text-green-400">âœ“ è½¦å¤´å·²ç¡®è®¤æ”¶æ¬¾</span>':'<span class="text-yellow-400">â³ ç­‰å¾…è½¦å¤´ç¡®è®¤...</span>';
            document.getElementById('myPaymentStatus').className=`text-center py-2 rounded ${myData.allPaid?'bg-green-800':'bg-yellow-800'}`;
        }else{myPaymentSection.classList.add('hidden');}
    }else{myPaymentSection.classList.add('hidden');}

    const myCodesSection=document.getElementById('myCodesSection');
    const myCodesList=document.getElementById('myCodesList');
    if(currentIdentity&&!isDriver){
        const myItems=items.filter(item=>item.owner===currentIdentity);
        const myItemsWithCode=myItems.filter(item=>item.code);
        if(myItemsWithCode.length>0){
            myCodesSection.classList.remove('hidden');
            myCodesList.innerHTML=myItemsWithCode.map(item=>`<div class="bg-gray-800 rounded p-3"><div class="text-sm text-gray-400 mb-1">${escapeHtml(item.name)}</div><div class="flex items-center justify-between"><code class="text-green-400 font-mono text-sm">${escapeHtml(item.code)}</code><button onclick="copyCode('${escapeHtml(item.code)}')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">å¤åˆ¶</button></div></div>`).join('');
        }else if(myItems.length>0){myCodesSection.classList.remove('hidden');myCodesList.innerHTML='<p class="text-gray-400 text-sm">è½¦å¤´è¿˜æ²¡å¡«å†™ä½ çš„å…‘æ¢ç ï¼Œè¯·ç¨ç­‰~</p>';}
        else{myCodesSection.classList.add('hidden');}
    }else{myCodesSection.classList.add('hidden');}

    const perPersonSection=document.getElementById('perPersonSection');
    if(items.length>0&&discount>0){
        perPersonSection.classList.remove('hidden');
        document.getElementById('perPersonList').innerHTML=perPersonData.map(p=>`<div class="flex justify-between text-sm bg-gray-700 rounded px-3 py-2"><span>${escapeHtml(p.name)} ${p.allPaid?'<span class="text-green-400">âœ“</span>':''}</span><span><span class="text-gray-400 line-through mr-2">Â¥${p.original}</span><span class="text-amber-400 font-bold">Â¥${p.final}</span></span></div>`).join('');
    }else{perPersonSection.classList.add('hidden');}

    const itemListEl=document.getElementById('itemList');
    if(items.length===0){itemListEl.innerHTML='<p class="text-gray-500 text-center py-4">æš‚æ— å•†å“ï¼Œæ·»åŠ ç¬¬ä¸€ä»¶å§ï¼</p>';}
    else{
        itemListEl.innerHTML=items.map(item=>{
            let codeSection='';
            if(isDriver){codeSection=item.code?`<div class="mt-2 flex items-center gap-2"><span class="text-xs text-green-400">âœ“ å·²å¡«ç </span><button onclick="openCodeModal(${item.id})" class="text-xs text-blue-400">ç¼–è¾‘</button></div>`:`<button onclick="openCodeModal(${item.id})" class="mt-2 text-xs text-yellow-400">+ å¡«å†™å…‘æ¢ç </button>`;}
            return `<div class="bg-gray-700 rounded p-3"><div class="flex items-center justify-between"><div><div class="font-medium">${escapeHtml(item.name)} ${item.paid?'<span class="text-green-400 text-xs">âœ“å·²ä»˜</span>':''}</div><div class="text-sm text-gray-400">${escapeHtml(item.owner)}</div></div><div class="flex items-center gap-3"><span class="text-amber-400">Â¥${item.price}</span><button onclick="removeItem(${item.id})" class="text-red-400 hover:text-red-300 text-sm">åˆ é™¤</button></div></div>${codeSection}</div>`;
        }).join('');
    }
}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),2000);}
function showLoading(show){document.getElementById('loading').classList.toggle('hidden',!show);}
function escapeHtml(text){const d=document.createElement('div');d.textContent=text;return d.innerHTML;}
</script>
</body>
</html>